
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://toweros.org/implementation/">
      
      
        <link rel="prev" href="../TowerOS%20Whitepaper.pdf">
      
      
        <link rel="next" href="../dev-environment/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.4.14">
    
    
      
        <title>Implementation - TowerOS</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.fad675c6.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#implementation" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="TowerOS" class="md-header__button md-logo" aria-label="TowerOS" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            TowerOS
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Implementation
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="TowerOS" class="md-nav__button md-logo" aria-label="TowerOS" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    TowerOS
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Getting Started
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Hardware
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../installation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installation and Upgrades
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Usage
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Usage
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../usage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Using TowerOS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../guides/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Guides
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../manual/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tower CLI Manual
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Security
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Security
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../security/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Security
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../secure-boot/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Secure Boot
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Technical
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Technical
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../TowerOS%20Whitepaper.pdf" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Whitepaper
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Implementation
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Implementation
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tower-tools" class="md-nav__link">
    <span class="md-ellipsis">
      Tower Tools
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#networking" class="md-nav__link">
    <span class="md-ellipsis">
      Networking
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Networking">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#firewall-rules" class="md-nav__link">
    <span class="md-ellipsis">
      Firewall Rules
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#building-your-own-toweros-images" class="md-nav__link">
    <span class="md-ellipsis">
      Building your own TowerOS Images
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Building your own TowerOS Images">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#image-for-thin-clients" class="md-nav__link">
    <span class="md-ellipsis">
      Image for Thin Clients
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#image-for-hosts" class="md-nav__link">
    <span class="md-ellipsis">
      Image for Hosts
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#system-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      System Configuration
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#host-provisioning" class="md-nav__link">
    <span class="md-ellipsis">
      Host Provisioning
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gui-application-execution" class="md-nav__link">
    <span class="md-ellipsis">
      GUI Application Execution
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#package-management" class="md-nav__link">
    <span class="md-ellipsis">
      Package Management
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/towercomputers/toweros" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    GitHub Repository
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Development
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Development
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dev-environment/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Developer Environment
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../build-toweros/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Building TowerOS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../qa-script/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    QA Script
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tower-tools" class="md-nav__link">
    <span class="md-ellipsis">
      Tower Tools
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#networking" class="md-nav__link">
    <span class="md-ellipsis">
      Networking
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Networking">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#firewall-rules" class="md-nav__link">
    <span class="md-ellipsis">
      Firewall Rules
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#building-your-own-toweros-images" class="md-nav__link">
    <span class="md-ellipsis">
      Building your own TowerOS Images
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Building your own TowerOS Images">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#image-for-thin-clients" class="md-nav__link">
    <span class="md-ellipsis">
      Image for Thin Clients
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#image-for-hosts" class="md-nav__link">
    <span class="md-ellipsis">
      Image for Hosts
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#system-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      System Configuration
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#host-provisioning" class="md-nav__link">
    <span class="md-ellipsis">
      Host Provisioning
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gui-application-execution" class="md-nav__link">
    <span class="md-ellipsis">
      GUI Application Execution
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#package-management" class="md-nav__link">
    <span class="md-ellipsis">
      Package Management
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="implementation">Implementation</h1>
<p>TowerOS is built on <a href="https://alpinelinux.org">Alpine Linux</a>, because of Alpine's simplicity, minimalism, and security-first approach. TowerOS is open-source and freely licensed (under the Apache License 2.0). It is designed to require the smallest-possible trusted computing base, to rely only on other widely used open-source software, and to be as transparent as possible in its implementation.</p>
<h2 id="tower-tools">Tower Tools</h2>
<p>The <code>toweros</code> package contains all of the tooling necessary to build TowerOS images for both the thin client and for the hosts (a pre-built image for the thin client—containing a pre-built image for hosts---is available on the <a href="https://github.com/towercomputers/toweros/releases">GitHub Releases</a> page).</p>
<p>This package is organized into six primary modules:</p>
<ul>
<li><code>buildthinclient.py</code> and <code>buildhost.py</code> to build the OS images used by the thin client and the hosts</li>
<li><code>sshconf.py</code> which manages TowerOS and SSH configuration files</li>
<li><code>provision.py</code>, <code>install.py</code>, and <code>gui.py</code> which allow you to provision a host, to install an application on it without an Internet connection, and to run a graphical application on a host from the thin client, respectively.</li>
</ul>
<h2 id="networking">Networking</h2>
<p>A TowerOS <strong>thin client</strong> connects to one or two separate networks of <strong>hosts</strong> (each network with an unmanaged switch). One network is connected to the Internet; the other (optional) network is offline. <em>Online</em> hosts reside on the first network; <em>offline</em> hosts on the second. On the online network, one of the hosts is the <strong>router</strong>: it is connected to the Internet directly and shares its connection with all the hosts connected to the same network.</p>
<p>All IPs are static and assigned by the <code>tower</code> tool. Here are the IPs used:</p>
<ul>
<li>TOWER_NETWORK_ONLINE = "192.168.2.0/24"</li>
<li>TOWER_NETWORK_OFFLINE = "192.168.3.0/24"</li>
<li>THIN_CLIENT_IP_ETH0 = "192.168.2.100"</li>
<li>THIN_CLIENT_IP_ETH1 = "192.168.3.100"</li>
<li>ROUTER_IP = "192.168.2.1"</li>
<li>FIRST_HOST_IP = 200 # 192.168.2.200 or 192.168.3.200</li>
</ul>
<h3 id="firewall-rules">Firewall Rules</h3>
<p>Firewalls are a primary element in the security of a TowerOS system. <code>iptables</code> is installed and configured on each host and on the thin client using the following two scripts:</p>
<ul>
<li>https://github.com/towercomputers/toweros/blob/dev/scripts/toweros-host/installer/configure-firewall.sh</li>
<li>https://github.com/towercomputers/toweros/blob/dev/scripts/toweros-thinclient/installer/configure-firewall.sh</li>
</ul>
<p>Both of these scripts are destructive and idempotent: they clean all the rules at the beginning and save the new rules at the end.</p>
<p>The thin client is configured with the <a href="https://wiki.archlinux.org/title/Simple_stateful_firewall">following guide</a></p>
<p>Hosts are configured the same way, but with the following additional rules:</p>
<ul>
<li>Port 22 is open to the thin client.</li>
<li>Offline hosts reject all outgoing traffic.</li>
<li>Online hosts reject outgoing traffic directed to the thin client or to other hosts.</li>
<li>The router has IP forwarding active, to share its connection with the other online hosts.</li>
</ul>
<h2 id="building-your-own-toweros-images">Building your own TowerOS Images</h2>
<h3 id="image-for-thin-clients">Image for Thin Clients</h3>
<p><code>buildthinclient.py</code> is the module responsible for generating an image of TowerOS with the <code>build-tower-image thinclient</code> command, which uses the <code>mkimage</code> tool (see <a href="https://wiki.alpinelinux.org/wiki/How_to_make_a_custom_ISO_image_with_mkimage">https://wiki.alpinelinux.org/wiki/How_to_make_a_custom_ISO_image_with_mkimage</a>).</p>
<p>The installer contains all the APK and pip packages necessary for installing the base system and <code>toweros</code>, which is ready to use after the first boot. In this way, the installation of the system, as well as the provisioning of a first host, does not require an Internet connection.</p>
<p>Here are the different steps taken by <code>buildthinclient.py</code> to generate an image:</p>
<ol>
<li>
<p>Gathering the necessary builds.
The script starts by checking for the existence of a <code>./dist</code>, <code>./builds</code> or <code>~/.cache/tower/builds/</code> folder. If one of them exists, this is where the script will fetch the builds and place the final image. If no folder exists, then the script creates the folder <code>~/.cache/tower/builds/</code>. Next:</p>
<ol>
<li>The script then verifies that the TowerOS host image is present. If not, it launches the build of a new image.</li>
<li>The script checks for the existence of a <code>toweros</code> wheel package. If it does not exist the package is retrieved from GitHub.</li>
</ol>
</li>
<li>
<p>Downloading <code>pip packages with</code>pip download` in a cache folder</p>
</li>
<li>
<p>Creating and updating an Alpine APK overlay folder, including most importantly:</p>
<ol>
<li>pip cache folder</li>
<li>Add the system install BASH scripts (see https://github.com/towercomputers/toweros/tree/dev/scripts/toweros-thinclient)</li>
<li>Include the TowerOS documentation</li>
<li>Add the <code>/etc</code> configuration files</li>
<li>Add builds required by <code>toweros</code> (TowerOS for the host, <code>toweros</code>)</li>
</ol>
</li>
<li>
<p>Launching <code>mkimage</code>, which takes care of the rest.</p>
</li>
<li>
<p>Renaming and copying the image into the <code>builds</code> folder.</p>
</li>
<li>
<p>Cleaning temporary files.</p>
</li>
</ol>
<p><strong>Notes about the TowerOS installer for the thin client:</strong></p>
<ul>
<li>The install scripts generally follow the official <a href="https://wiki.alpinelinux.org/wiki/Installation">Alpine Linux install guide</a>.</li>
<li>The installer sets up an <code>iptables</code> firewall as described in the <a href="https://wiki.archlinux.org/title/Simple_stateful_firewall">Arch Linux Wiki</a>.</li>
<li>The script uses SysLinux as the boot loader.</li>
</ul>
<h3 id="image-for-hosts">Image for Hosts</h3>
<p><code>buildhost.py</code> is the module responsible for generating an image for the thin client when the <code>build-tower-image host</code> command is executed, and also for configuring the image when the <code>tower provision</code> command is called.</p>
<p><code>buildhost.py</code> uses the same method as <code>pigen</code> to build an image for a Raspberry Pi (see <a href="https://github.com/RPi-Distro/pi-gen/blob/master/export-image/prerun.sh">https://github.com/RPi-Distro/pi-gen/blob/master/export-image/prerun.sh</a>) but unlike <code>pigen</code>, which uses a Debian-based system, <code>buildhost.py</code> uses an Alpine Linux–based system (see https://wiki.alpinelinux.org/wiki/Classic_install_or_sys_mode_on_Raspberry_Pi).</p>
<p>The <code>tower provision</code> command finalises the configuration of the image, which is otherwise neither secure nor ready to be used by <code>toweros</code>.</p>
<p>Here are the different steps taken by <code>buildhost.py</code> to generate an image:</p>
<ol>
<li>
<p>Install an Alpine Linux system in a mounted temporary folder:</p>
<ol>
<li>Create an image file with <code>mkfs.ext4</code></li>
<li>Mount this image with <code>mount</code></li>
<li>Install a minimal Alpine Linux system, as well as NX, in the mounted folder (<a href="https://dl-cdn.alpinelinux.org/alpine/v3.17/releases/armv7/alpine-rpi-3.17.3-armv7.tar.gz">https://dl-cdn.alpinelinux.org/alpine/v3.17/releases/armv7/alpine-rpi-3.17.3-armv7.tar.gz</a>)</li>
</ol>
</li>
<li>
<p>Create the necessary partitions with <code>parted</code> and stores them in an image file, with the sizes adapted for the system installed in step 1.</p>
</li>
<li>
<p>Copy the installed system into the newly-created partitions with <code>rsync</code></p>
</li>
<li>
<p>Compress the image containing the partitions</p>
</li>
<li>
<p>Unmount and cleans up temporary files and folders</p>
</li>
</ol>
<p>Here are the different steps taken by <code>buildhost.py</code> to configure an image when provisioning an host:</p>
<ol>
<li>
<p>Copy the image to the SD card</p>
</li>
<li>
<p>Grow the root partition to occupy entire SD card</p>
</li>
<li>
<p>Place a <code>tower.env</code> file in the root directory of the boot partition. This file contains all the variables needed to install the system on the first boot (<code>HOSTNAME</code>, <code>USERNAME</code>, <code>PUBLIC_KEY</code>, ...).</p>
</li>
<li>
<p>Unmount the SD card, which is ready to be inserted into the host device.</p>
</li>
</ol>
<p>Note: A TowerOS image for the thin client is placed in the <code>~/.cache/tower/builds/</code> folder by the installer.</p>
<h2 id="system-configuration">System Configuration</h2>
<p>All configuration files and keys used by <code>tower</code> are in the <code>~/.local/tower</code> folder. This folder contains:</p>
<ul>
<li>
<p>the <code>config</code> file which contains the list of hosts. This file is compatible with <code>ssh</code> and is included in the <code>~/.ssh/config</code> file.</p>
</li>
<li>
<p>one folder per host containing:</p>
<ul>
<li><code>tower.env</code> (configuration file used to install the host)</li>
<li><code>id_ed25519</code> (ssh private key to connect to the host)</li>
<li><code>id_ed25519.pub</code> (ssh public key)</li>
<li><code>crypto_keyfile.bin</code> (luks key used to encrypt the host root disk)</li>
<li><code>world</code> (installed apks with <code>tower install</code>)</li>
</ul>
</li>
</ul>
<h2 id="host-provisioning">Host Provisioning</h2>
<p><code>provision.py</code> is used by the <code>tower provision &lt;host&gt;</code> command to prepare an SD card directly usable by a Rasbperry Pi.</p>
<p>The steps to provision a host are as follows:</p>
<ol>
<li>Gereate a key pair.</li>
<li>Generate the host configuration (<code>tower.env</code>) with the values provided on the command line or with those retrieved from the thin client</li>
<li>Copy of the TowerOS thin client image onto the SD card and include the configuration file</li>
<li>Wait for the new host to be detected on the network after the user has inserted the SD card into the host device</li>
<li>Update the <code>ssh</code> and <code>toweros</code> configuration files</li>
</ol>
<p>Once a host has been provisioned, it should be accessible with <code>$ ssh &lt;host&gt;</code> or <code>$ tower run &lt;host&gt; &lt;command&gt;</code>.</p>
<h2 id="gui-application-execution">GUI Application Execution</h2>
<p><code>gui.py</code> is a module that allows the use of the NX protocol through an SSH tunnel: it allows the user run an application on one of the hosts from the safety of the thin client.</p>
<p><code>nxagent</code> must be installed on the host, and <code>nxproxy</code> on the thin client. Of course, both are included in the TowerOS images.</p>
<p>Here are the steps taken by <code>gui.py</code> to run an application on one of the hosts:</p>
<ol>
<li>
<p>Generate a unique cookie which is added in the host with <code>xauth add</code></p>
</li>
<li>
<p>Launch <code>nxagent</code> (configured to accept only local connections) on the host using <code>ssh</code></p>
</li>
<li>
<p>Open an SSH tunnel between the host and the thin client on the port used by <code>nxagent</code></p>
</li>
<li>
<p>Launch <code>nxproxy</code> with the generated cookie and on the port associated with the SSH tunnel</p>
</li>
</ol>
<p><em>At this stage <code>nxproxy</code> and <code>nxagent</code> are connected, and we have a virtual screen, on which we run the graphical application with: <code>ssh &lt;host&gt; DISPLAY=:50 &lt;application-name&gt;application&gt;</code>.</em></p>
<p>After the application has been closed, <code>gui.py</code> will perform the following actions:</p>
<ol>
<li>Terminate <code>nxagent</code> and close the SSH tunnel</li>
<li>Revoke the cookie with <code>xauth remove</code></li>
<li>Terminate <code>nxproxy</code></li>
</ol>
<p>The GUI system therefor works the same way as X2GO, which provided the inspiration.</p>
<h2 id="package-management">Package Management</h2>
<p>This module allows to use of <code>apk</code> on an offline host through an SSH tunnel through the router. To do this, it performs the following steps:</p>
<ol>
<li>
<p>Prepare the offline host to redirect requests to the APK repository to the thin client:</p>
<ol>
<li>Add <code>127.0.0.1 &lt;apk_repo_host&gt;</code> to the <code>/etc/hosts</code> file</li>
<li>Add an <code>iptables</code> rule to redirect requests on port 80 to port 4443 (so you don't need to open the tunnel as <code>root</code>, port 80 being protected)</li>
<li>Prepare a <code>pacman.conf</code> file containing only the <code>apk_repo_host</code></li>
<li>Open a tunnel to redirect port 4443 on the offline host to port 4666 on the thin client.</li>
</ol>
</li>
<li>
<p>Open a tunnel to redirect port 4666 from thin client to the APK repository on the online host with: <code>ssh -R 4666:&lt;apk_repo_host&gt;:80 &lt;online-host&gt;</code></p>
</li>
</ol>
<p><em>At this point the module can normally use <code>apk</code> with <code>ssh</code> on the offline host to install the desired packages</em></p>
<p>Once the installation has finished, <code>gui.py</code> cleans the <code>/etc/hosts</code> file and the <code>iptables</code> rules from the offline host and closes the SSH tunnels.</p>
<p>Note: when installing each package, <code>apk</code> verifies that it has been signed by the authors and maintainers of Alpine Linux. Therefore it is not necessary to trust the online host, but rather to initialise the APK keys in a trusted environment. For users of TowerOS, this means it is imperative to build the TowerOS images in a trusted environment and to manually verify the integrity of the keys.</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.sections", "navigation.expand", "navigation.instant", "navigation.instant.prefetch"], "search": "../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.cd18aaf1.min.js"></script>
      
    
  </body>
</html>